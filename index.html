<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Galaga - Space Monster Defense</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: 'Courier New', monospace;
            background: #000;
            color: #fff;
            overflow: hidden;
        }

        /* Desktop styles */
        @media (min-width: 769px) {
            body {
                display: flex;
                justify-content: center;
                align-items: center;
                min-height: 100vh;
            }

            .game-container {
                background: #111;
                border: 4px solid #00ff00;
                border-radius: 10px;
                padding: 20px;
                box-shadow: 0 0 30px rgba(0, 255, 0, 0.3);
                max-width: 640px;
            }

            #mobileControls {
                display: none !important;
            }
        }

        /* Mobile styles */
        @media (max-width: 768px) {
            body {
                display: flex;
                flex-direction: column;
                height: 100vh;
                width: 100vw;
            }

            .game-container {
                flex: 1;
                display: flex;
                flex-direction: column;
                background: #111;
                border: none;
                padding: 0;
                border-radius: 0;
                overflow: hidden;
            }

            .game-stats {
                flex-shrink: 0;
            }

            canvas {
                flex: 1;
                width: 100% !important;
                height: auto !important;
                border: none !important;
            }

            .controls {
                display: none !important;
            }

            .instructions {
                display: none !important;
            }
        }

        .game-header {
            text-align: center;
            margin-bottom: 15px;
        }

        .game-title {
            font-size: 36px;
            color: #ff0;
            text-shadow: 0 0 10px #ff0, 0 0 20px #ff0;
            margin-bottom: 5px;
            letter-spacing: 3px;
        }

        .game-subtitle {
            font-size: 14px;
            color: #0ff;
            letter-spacing: 2px;
        }

        .game-stats {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            padding: 10px;
            background: #000;
            border: 2px solid #00ff00;
            border-radius: 5px;
            flex-wrap: wrap;
        }

        .stat {
            font-size: 16px;
            color: #0f0;
            margin: 5px;
        }

        .stat-value {
            color: #fff;
            font-weight: bold;
        }

        canvas {
            display: block;
            background: #000;
            border: 3px solid #00ff00;
            box-shadow: 0 0 20px rgba(0, 255, 0, 0.5);
            width: 100%;
            height: auto;
        }

        .controls {
            margin-top: 15px;
            text-align: center;
        }

        .btn {
            background: #ff0;
            color: #000;
            border: none;
            padding: 12px 20px;
            font-size: 14px;
            font-weight: bold;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
            font-family: 'Courier New', monospace;
            box-shadow: 0 0 10px rgba(255, 255, 0, 0.5);
            transition: all 0.2s;
        }

        .btn:hover {
            background: #ffff00;
            box-shadow: 0 0 20px rgba(255, 255, 0, 0.8);
            transform: scale(1.05);
        }

        .btn:active {
            transform: scale(0.95);
        }

        .btn-secondary {
            background: #0ff;
            color: #000;
            box-shadow: 0 0 10px rgba(0, 255, 255, 0.5);
        }

        .btn-secondary:hover {
            background: #00ffff;
            box-shadow: 0 0 20px rgba(0, 255, 255, 0.8);
        }

        .instructions {
            margin-top: 15px;
            padding: 15px;
            background: rgba(0, 255, 0, 0.1);
            border: 2px solid #0f0;
            border-radius: 5px;
            font-size: 12px;
            line-height: 1.8;
            color: #0ff;
        }

        /* Mobile controller */
        #mobileControls {
            display: none;
            background: rgba(20, 20, 40, 0.98);
            padding: 15px 10px 20px 10px;
            border-top: 3px solid #00ff00;
            min-height: 180px;
            flex-shrink: 0;
        }

        @media (max-width: 768px) {
            #mobileControls {
                display: flex !important;
                justify-content: space-around;
                align-items: center;
            }
        }

        .mobile-controls-inner {
            display: flex;
            justify-content: space-around;
            align-items: center;
            width: 100%;
            max-width: 600px;
            margin: 0 auto;
        }

        /* D-pad */
        .dpad {
            display: grid;
            grid-template-columns: repeat(3, 70px);
            grid-template-rows: repeat(3, 70px);
            gap: 5px;
        }

        .dpad-btn {
            background: linear-gradient(145deg, #ff6b6b, #ee5a52);
            border: 3px solid #ffaa00;
            border-radius: 12px;
            color: white;
            font-size: 24px;
            font-weight: bold;
            cursor: pointer;
            user-select: none;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 6px 0 #aa3939, 0 8px 15px rgba(0, 0, 0, 0.5);
            transition: all 0.1s;
            touch-action: manipulation;
        }

        .dpad-btn:active {
            transform: translateY(4px);
            box-shadow: 0 2px 0 #aa3939, 0 4px 8px rgba(0, 0, 0, 0.5);
        }

        .dpad-btn.left { grid-column: 1; grid-row: 2; }
        .dpad-btn.right { grid-column: 3; grid-row: 2; }

        /* Action buttons */
        .action-buttons {
            display: flex;
            flex-direction: column;
            gap: 10px;
            align-items: center;
        }

        .fire-btn {
            width: 100px;
            height: 100px;
            background: linear-gradient(145deg, #4ecdc4, #44b3aa);
            border: 4px solid #ffd700;
            border-radius: 50%;
            color: white;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            user-select: none;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            box-shadow: 0 8px 0 #2a7d77, 0 10px 20px rgba(0, 0, 0, 0.5);
            transition: all 0.1s;
            touch-action: manipulation;
        }

        .fire-btn:active {
            transform: translateY(6px);
            box-shadow: 0 2px 0 #2a7d77, 0 4px 10px rgba(0, 0, 0, 0.5);
        }

        .fire-btn-icon {
            font-size: 36px;
        }

        .pause-btn-mobile {
            width: 70px;
            height: 40px;
            background: linear-gradient(145deg, #95a5a6, #7f8c8d);
            border: 3px solid #ffd700;
            border-radius: 8px;
            color: white;
            font-size: 12px;
            font-weight: bold;
            cursor: pointer;
            user-select: none;
            box-shadow: 0 4px 0 #5a6268, 0 6px 10px rgba(0, 0, 0, 0.5);
            transition: all 0.1s;
            touch-action: manipulation;
        }

        .pause-btn-mobile:active {
            transform: translateY(3px);
            box-shadow: 0 1px 0 #5a6268, 0 3px 5px rgba(0, 0, 0, 0.5);
        }

        @media (max-width: 480px) {
            .dpad {
                grid-template-columns: repeat(3, 55px);
                grid-template-rows: repeat(3, 55px);
            }

            .fire-btn {
                width: 85px;
                height: 85px;
                font-size: 16px;
            }

            .fire-btn-icon {
                font-size: 30px;
            }

            #mobileControls {
                min-height: 150px;
                padding: 10px 5px 15px 5px;
            }

            .stat {
                font-size: 13px;
            }
        }

        .screen-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.95);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .screen-content {
            background: #111;
            padding: 40px;
            border: 4px solid #00ff00;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 0 30px rgba(0, 255, 0, 0.5);
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .screen-title {
            font-size: 36px;
            color: #ff0;
            margin-bottom: 20px;
            font-weight: bold;
            text-shadow: 0 0 10px #ff0;
        }

        .form-group {
            margin-bottom: 20px;
            text-align: left;
        }

        .form-label {
            display: block;
            color: #0ff;
            font-size: 14px;
            margin-bottom: 8px;
            font-weight: bold;
        }

        .form-input {
            width: 100%;
            padding: 12px;
            font-size: 16px;
            border: 2px solid #00ff00;
            background: #000;
            color: #fff;
            border-radius: 5px;
            font-family: 'Courier New', monospace;
        }

        .form-input:focus {
            outline: none;
            border-color: #0ff;
            box-shadow: 0 0 10px rgba(0, 255, 255, 0.5);
        }

        .error-message {
            color: #f00;
            font-size: 14px;
            margin-top: 10px;
            display: none;
        }

        .error-message.show {
            display: block;
        }

        .game-over-screen,
        .stage-clear-screen {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.95);
            padding: 40px;
            border: 4px solid #ff0;
            border-radius: 10px;
            text-align: center;
            display: none;
            box-shadow: 0 0 30px rgba(255, 255, 0, 0.5);
            z-index: 5;
        }

        .game-over-screen.show,
        .stage-clear-screen.show {
            display: block;
        }

        .stage-clear-screen {
            border-color: #0ff;
        }

        .levelup-popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0);
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 30px 40px;
            border-radius: 20px;
            border: 4px solid #ffd700;
            box-shadow: 0 0 50px rgba(255, 215, 0, 0.8);
            z-index: 1001;
            text-align: center;
            animation: popupBounce 0.5s ease forwards;
            display: none;
        }

        .levelup-popup.show {
            display: block;
        }

        @keyframes popupBounce {
            0% { transform: translate(-50%, -50%) scale(0); }
            50% { transform: translate(-50%, -50%) scale(1.1); }
            100% { transform: translate(-50%, -50%) scale(1); }
        }

        .levelup-title {
            font-size: 32px;
            color: #ffd700;
            font-weight: bold;
            margin-bottom: 15px;
            text-shadow: 0 0 15px #ffd700;
        }

        .levelup-text {
            font-size: 20px;
            color: #fff;
            margin-bottom: 10px;
        }

        .levelup-bonus {
            font-size: 16px;
            color: #0ff;
            margin-top: 15px;
            padding: 10px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
        }
    </style>
</head>
<body>
    <div class="game-container">
        <div class="game-header">
            <div class="game-title">üöÄ GALAGA üöÄ</div>
            <div class="game-subtitle">Space Monster Defense</div>
        </div>
        
        <div class="game-stats">
            <div class="stat">Player: <span class="stat-value" id="playerName">()</span></div>
            <div class="stat">Difficulty: <span class="stat-value" id="difficulty">1/10</span></div>
            <div class="stat">Score: <span class="stat-value" id="score">0</span></div>
            <div class="stat">Stage: <span class="stat-value" id="stage">1</span></div>
            <div class="stat">Lives: <span class="stat-value" id="lives">‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è</span></div>
            <div class="stat">Best: <span class="stat-value" id="highScore">0</span></div>
        </div>
        
        <canvas id="gameCanvas" width="600" height="600"></canvas>
        
        <div class="controls">
            <button class="btn" onclick="game.restart()">New Game</button>
            <button class="btn btn-secondary" onclick="game.togglePause()">Pause (P)</button>
            <button class="btn btn-secondary" onclick="showLeaderboard()">Leaderboard</button>
        </div>
        
        <div class="instructions">
            <strong>üéÆ Controls:</strong><br>
            üíª <strong>PC:</strong> ‚Üê ‚Üí Arrow keys: Move | Spacebar: Fire | P key: Pause<br>
            üì± <strong>Mobile:</strong> ‚óÄ‚ñ∂ Buttons: Move | üöÄ Button: Fire<br><br>
            <strong>üìñ Goal:</strong><br>
            Clear all 10 stages! Difficulty increases with each level!
        </div>
    </div>

    <!-- Mobile controller -->
    <div id="mobileControls">
        <div class="mobile-controls-inner">
            <!-- D-pad -->
            <div class="dpad">
                <button class="dpad-btn left" id="btnLeft">‚óÄ</button>
                <button class="dpad-btn right" id="btnRight">‚ñ∂</button>
            </div>

            <!-- Action buttons -->
            <div class="action-buttons">
                <button class="fire-btn" id="btnFire">
                    <div class="fire-btn-icon">üöÄ</div>
                    <div>FIRE</div>
                </button>
                <button class="pause-btn-mobile" id="btnPauseMobile">PAUSE</button>
            </div>
        </div>
    </div>

    <!-- Level up popup -->
    <div class="levelup-popup" id="levelupPopup">
        <div class="levelup-title">‚≠ê LEVEL UP! ‚≠ê</div>
        <div class="levelup-text">Stage <span id="levelupStage">2</span></div>
        <div class="levelup-bonus" id="levelupBonus"></div>
    </div>

    <!-- Game over screen -->
    <div class="game-over-screen" id="gameOverScreen">
        <h2 class="screen-title" style="color: #f00;">GAME OVER</h2>
        <div style="font-size: 24px; color: #fff; margin-bottom: 20px;">
            Final Score: <span id="finalScore">0</span>
        </div>
        <div style="font-size: 18px; color: #0ff; margin-bottom: 30px;">
            Saving score...
        </div>
        <button class="btn" onclick="game.restart()">Play Again</button>
        <button class="btn btn-secondary" onclick="showLeaderboardFromGame()">View Leaderboard</button>
    </div>

    <!-- Stage clear screen -->
    <div class="stage-clear-screen" id="stageClearScreen">
        <h2 class="stage-clear-title" style="color: #0ff; font-size: 36px; margin-bottom: 20px;">STAGE CLEAR!</h2>
        <div style="font-size: 24px; color: #fff; margin-bottom: 20px;">
            Preparing next stage...
        </div>
    </div>

    <!-- Start screen -->
    <div class="screen-overlay" id="startScreen">
        <div class="screen-content">
            <h2 class="screen-title">üöÄ GALAGA üöÄ</h2>
            <div class="form-group">
                <label class="form-label">Enter your student ID:</label>
                <input type="text" class="form-input" id="studentIdInput" placeholder="e.g., 20241234" maxlength="20">
                <div class="error-message" id="studentIdError">Please enter your student ID!</div>
            </div>
            <div class="form-group">
                <label class="form-label">Enter your name:</label>
                <input type="text" class="form-input" id="playerNameInput" placeholder="Your name..." maxlength="20">
                <div class="error-message" id="nameError">Please enter your name!</div>
            </div>
            <button class="btn" onclick="startGame()">Start Game</button>
            <button class="btn btn-secondary" onclick="showLeaderboard()">View Leaderboard</button>
        </div>
    </div>

    <!-- Leaderboard screen -->
    <div class="screen-overlay" id="leaderboardScreen" style="display: none;">
        <div class="screen-content">
            <h2 class="screen-title">üèÜ Leaderboard üèÜ</h2>
            <div id="leaderboardContent" style="margin: 20px 0; max-height: 400px; overflow-y: auto;">
                <p style="color: #0ff;">Loading...</p>
            </div>
            <button class="btn" onclick="hideLeaderboard()">Back</button>
            <button class="btn btn-secondary" onclick="loadLeaderboard()">Refresh</button>
        </div>
    </div>

    <script>
        // Firebase initialization status flag
        window.firebaseReady = false;
        window.useLocalStorage = false;
        
        // LocalStorage based score management
        const LocalScores = {
            save: function(score, stage, playerName, studentId) {
                const scores = this.getAll();
                scores.push({
                    studentId: studentId,
                    playerName: playerName,
                    score: score,
                    stage: stage,
                    timestamp: Date.now(),
                    date: new Date().toISOString()
                });
                localStorage.setItem('galagaScores', JSON.stringify(scores));
                console.log('‚úÖ Score saved locally!');
            },
            
            getAll: function() {
                const data = localStorage.getItem('galagaScores');
                return data ? JSON.parse(data) : [];
            },
            
            getTop: function(limit = 10) {
                const scores = this.getAll();
                return scores.sort((a, b) => b.score - a.score).slice(0, limit);
            }
        };
        
        // Firebase functions - temporary definitions (error prevention before module load)
        window.saveScore = function(score, stage) { 
            console.log('Waiting to save score...', score, stage);
            // Temporarily save to localStorage
            if (window.game && window.game.playerName && window.game.studentId) {
                LocalScores.save(score, stage, window.game.playerName, window.game.studentId);
            }
        };
        
        window.loadLeaderboard = function() { 
            const content = document.getElementById('leaderboardContent');
            if (content) {
                content.innerHTML = '<p style="color: #0ff;">Loading leaderboard...</p>';
                
                // Load from localStorage
                setTimeout(() => {
                    const scores = LocalScores.getTop(10);
                    
                    if (scores.length > 0) {
                        let html = '<div style="margin-bottom: 10px; color: #ff0; font-size: 12px;">üíæ Local Leaderboard</div>';
                        html += '<table style="width: 100%; border-collapse: collapse; color: #fff;">';
                        html += '<tr style="background: rgba(0, 255, 0, 0.2); border-bottom: 2px solid #0f0;">';
                        html += '<th style="padding: 10px; text-align: center;">Rank</th>';
                        html += '<th style="padding: 10px; text-align: left;">Student ID</th>';
                        html += '<th style="padding: 10px; text-align: left;">Name</th>';
                        html += '<th style="padding: 10px; text-align: center;">Score</th>';
                        html += '<th style="padding: 10px; text-align: center;">Stage</th>';
                        html += '</tr>';
                        
                        scores.forEach((score, index) => {
                            const rankColor = index === 0 ? '#ffd700' : index === 1 ? '#c0c0c0' : index === 2 ? '#cd7f32' : '#0ff';
                            const rankIcon = index === 0 ? 'ü•á' : index === 1 ? 'ü•à' : index === 2 ? 'ü•â' : `${index + 1}`;
                            html += `<tr style="border-bottom: 1px solid #333;">`;
                            html += `<td style="padding: 10px; text-align: center; color: ${rankColor}; font-weight: bold;">${rankIcon}</td>`;
                            html += `<td style="padding: 10px; text-align: left; color: #0ff;">${score.studentId || 'N/A'}</td>`;
                            html += `<td style="padding: 10px; text-align: left;">${score.playerName}</td>`;
                            html += `<td style="padding: 10px; text-align: center; color: #ff0; font-weight: bold;">${score.score}</td>`;
                            html += `<td style="padding: 10px; text-align: center;">${score.stage}</td>`;
                            html += `</tr>`;
                        });
                        html += '</table>';
                        content.innerHTML = html;
                    } else {
                        content.innerHTML = `
                            <p style="color: #0ff; margin: 20px;">No scores yet!</p>
                            <p style="color: #888; font-size: 14px;">Be the first to set a record!</p>
                        `;
                    }
                }, 100);
            }
        };
        
        window.showLeaderboard = function() { 
            document.getElementById('leaderboardScreen').style.display = 'flex';
            loadLeaderboard();
        };
        window.showLeaderboardFromGame = function() { 
            document.getElementById('gameOverScreen').classList.remove('show');
            showLeaderboard();
        };
        window.hideLeaderboard = function() { 
            document.getElementById('leaderboardScreen').style.display = 'none';
        };
    </script>

    <script type="module">
        // Firebase configuration - FILL IN YOUR FIREBASE CONFIG HERE
        /*
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getDatabase, ref, push, query, orderByChild, limitToLast, get } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';

        const firebaseConfig = {
            apiKey: "AIzaSyDKHFod7Hr8qeUgUb052Ir3DCxF0ZRb6To",
  authDomain: "sswt2025fall.firebaseapp.com",
  databaseURL: "https://sswt2025fall-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "sswt2025fall",
  storageBucket: "sswt2025fall.firebasestorage.app",
  messagingSenderId: "304733564282",
  appId: "1:304733564282:web:e8ec392e6fe4bf871dbac3",
  measurementId: "G-RRWD5Z2C16"
        };

        try {
            console.log('üî• Initializing Firebase...');
            const app = initializeApp(firebaseConfig);
            const database = getDatabase(app);
            console.log('‚úÖ Firebase app initialized!');

            // Override Firebase functions with actual implementation
            window.saveScore = async function(score, stage) {
                try {
                    console.log('üíæ Attempting to save score:', score, stage, game.playerName, game.studentId);
                    
                    // Also save locally (backup)
                    LocalScores.save(score, stage, game.playerName, game.studentId);
                    
                    // Attempt to save to Firebase
                    const scoresRef = ref(database, 'scores');
                    await push(scoresRef, {
                        studentId: game.studentId,
                        playerName: game.playerName,
                        score: score,
                        stage: stage,
                        timestamp: Date.now(),
                        date: new Date().toISOString()
                    });
                    console.log('‚úÖ Score saved to Firebase!');
                    window.useLocalStorage = false;
                } catch (error) {
                    console.error('‚ùå Firebase save failed, using local storage only:', error.message);
                    window.useLocalStorage = true;
                }
            };

            window.loadLeaderboard = async function() {
                const leaderboardContent = document.getElementById('leaderboardContent');
                
                try {
                    console.log('üìä Loading leaderboard...');
                    leaderboardContent.innerHTML = '<p style="color: #0ff;">Loading leaderboard...</p>';
                    
                    const scoresRef = ref(database, 'scores');
                    const scoresQuery = query(scoresRef, orderByChild('score'), limitToLast(10));
                    
                    console.log('üîç Executing Firebase query...');
                    const snapshot = await get(scoresQuery);
                    console.log('üì• Firebase response received:', snapshot.exists());
                    
                    if (snapshot.exists()) {
                        const scores = [];
                        snapshot.forEach((childSnapshot) => {
                            scores.push(childSnapshot.val());
                        });
                        
                        console.log('üìà Loaded scores count:', scores.length);
                        scores.sort((a, b) => b.score - a.score);
                        
                        let html = '<div style="margin-bottom: 10px; color: #0f0; font-size: 12px;">üåê Online Leaderboard</div>';
                        html += '<table style="width: 100%; border-collapse: collapse; color: #fff;">';
                        html += '<tr style="background: rgba(0, 255, 0, 0.2); border-bottom: 2px solid #0f0;">';
                        html += '<th style="padding: 10px; text-align: center;">Rank</th>';
                        html += '<th style="padding: 10px; text-align: left;">Student ID</th>';
                        html += '<th style="padding: 10px; text-align: left;">Name</th>';
                        html += '<th style="padding: 10px; text-align: center;">Score</th>';
                        html += '<th style="padding: 10px; text-align: center;">Stage</th>';
                        html += '</tr>';
                        
                        scores.forEach((score, index) => {
                            const rankColor = index === 0 ? '#ffd700' : index === 1 ? '#c0c0c0' : index === 2 ? '#cd7f32' : '#0ff';
                            const rankIcon = index === 0 ? 'ü•á' : index === 1 ? 'ü•à' : index === 2 ? 'ü•â' : `${index + 1}`;
                            html += `<tr style="border-bottom: 1px solid #333;">`;
                            html += `<td style="padding: 10px; text-align: center; color: ${rankColor}; font-weight: bold;">${rankIcon}</td>`;
                            html += `<td style="padding: 10px; text-align: left; color: #0ff;">${score.studentId || 'N/A'}</td>`;
                            html += `<td style="padding: 10px; text-align: left;">${score.playerName}</td>`;
                            html += `<td style="padding: 10px; text-align: center; color: #ff0; font-weight: bold;">${score.score}</td>`;
                            html += `<td style="padding: 10px; text-align: center;">${score.stage}</td>`;
                            html += `</tr>`;
                        });
                        
                        html += '</table>';
                        leaderboardContent.innerHTML = html;
                        console.log('‚úÖ Online leaderboard displayed!');
                        window.useLocalStorage = false;
                    } else {
                        console.log('‚ö†Ô∏è No Firebase data, using local data');
                        throw new Error('No Firebase data');
                    }
                } catch (error) {
                    console.warn('‚ö†Ô∏è Firebase load failed, using local leaderboard:', error.message);
                    
                    // Load from localStorage
                    const scores = LocalScores.getTop(10);
                    
                    if (scores.length > 0) {
                        let html = '<div style="margin-bottom: 10px; color: #ff0; font-size: 12px;">üíæ Local Leaderboard (This Device Only)</div>';
                        html += '<table style="width: 100%; border-collapse: collapse; color: #fff;">';
                        html += '<tr style="background: rgba(0, 255, 0, 0.2); border-bottom: 2px solid #0f0;">';
                        html += '<th style="padding: 10px; text-align: center;">Rank</th>';
                        html += '<th style="padding: 10px; text-align: left;">Student ID</th>';
                        html += '<th style="padding: 10px; text-align: left;">Name</th>';
                        html += '<th style="padding: 10px; text-align: center;">Score</th>';
                        html += '<th style="padding: 10px; text-align: center;">Stage</th>';
                        html += '</tr>';
                        
                        scores.forEach((score, index) => {
                            const rankColor = index === 0 ? '#ffd700' : index === 1 ? '#c0c0c0' : index === 2 ? '#cd7f32' : '#0ff';
                            const rankIcon = index === 0 ? 'ü•á' : index === 1 ? 'ü•à' : index === 2 ? 'ü•â' : `${index + 1}`;
                            html += `<tr style="border-bottom: 1px solid #333;">`;
                            html += `<td style="padding: 10px; text-align: center; color: ${rankColor}; font-weight: bold;">${rankIcon}</td>`;
                            html += `<td style="padding: 10px; text-align: left; color: #0ff;">${score.studentId || 'N/A'}</td>`;
                            html += `<td style="padding: 10px; text-align: left;">${score.playerName}</td>`;
                            html += `<td style="padding: 10px; text-align: center; color: #ff0; font-weight: bold;">${score.score}</td>`;
                            html += `<td style="padding: 10px; text-align: center;">${score.stage}</td>`;
                            html += `</tr>`;
                        });
                        html += '</table>';
                        html += '<p style="color: #888; font-size: 12px; margin-top: 10px;">Firebase connection required for online leaderboard.</p>';
                        leaderboardContent.innerHTML = html;
                        console.log('‚úÖ Local leaderboard displayed!');
                    } else {
                        leaderboardContent.innerHTML = `
                            <p style="color: #0ff; margin: 20px;">No scores yet!</p>
                            <p style="color: #888; font-size: 14px;">Be the first to set a record!</p>
                        `;
                    }
                    
                    window.useLocalStorage = true;
                }
            };

            window.showLeaderboard = function() {
                console.log('üìä Showing leaderboard screen');
                document.getElementById('leaderboardScreen').style.display = 'flex';
                loadLeaderboard();
            };

            window.showLeaderboardFromGame = function() {
                console.log('üéÆ Showing leaderboard after game over');
                document.getElementById('gameOverScreen').classList.remove('show');
                showLeaderboard();
            };

            window.hideLeaderboard = function() {
                console.log('‚ùå Hiding leaderboard screen');
                document.getElementById('leaderboardScreen').style.display = 'none';
            };

            window.firebaseReady = true;
            console.log('‚úÖ Firebase fully initialized!');
            
        } catch (error) {
            console.error('‚ùå Firebase initialization failed:', error.message);
            console.warn('‚ö†Ô∏è Switching to local storage mode');
            window.useLocalStorage = true;
        }
        */
        
        // Firebase is disabled - using local storage only
        console.log('üíæ Running in local storage mode');
        console.log('‚ÑπÔ∏è To enable Firebase: Uncomment the Firebase code above and add your config');
        window.useLocalStorage = true;
    </script>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        
        window.startGame = function() {
            const studentIdInput = document.getElementById('studentIdInput');
            const nameInput = document.getElementById('playerNameInput');
            const studentId = studentIdInput.value.trim();
            const name = nameInput.value.trim();
            
            if (!studentId) {
                document.getElementById('studentIdError').classList.add('show');
                return;
            }
            
            if (!name) {
                document.getElementById('nameError').classList.add('show');
                return;
            }
            
            document.getElementById('studentIdError').classList.remove('show');
            document.getElementById('nameError').classList.remove('show');
            document.getElementById('startScreen').style.display = 'none';
            
            game.studentId = studentId;
            game.playerName = name;
            document.getElementById('playerName').textContent = `${studentId} - ${name}`;
            game.start();
        };
        
        document.getElementById('playerNameInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                startGame();
            }
        });
        
        document.getElementById('studentIdInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                document.getElementById('playerNameInput').focus();
            }
        });
        
        const game = {
            player: {
                x: canvas.width / 2 - 20,
                y: canvas.height - 60,
                width: 40,
                height: 30,
                speed: 5,
                color: '#0ff'
            },
            bullets: [],
            enemies: [],
            enemyBullets: [],
            particles: [],
            stars: [],
            score: 0,
            lives: 3,
            stage: 1,
            highScore: 0,
            isRunning: false,
            isPaused: false,
            keys: {},
            playerName: '',
            studentId: '',
            lastEnemyShot: 0,
            enemyShotDelay: 1000,
            
            init() {
                this.highScore = parseInt(localStorage.getItem('galagaHighScore')) || 0;
                document.getElementById('highScore').textContent = this.highScore;
                
                for (let i = 0; i < 100; i++) {
                    this.stars.push({
                        x: Math.random() * canvas.width,
                        y: Math.random() * canvas.height,
                        size: Math.random() * 2
                    });
                }
                
                this.setupControls();
                this.setupMobileControls();
            },
            
            setupControls() {
                document.addEventListener('keydown', (e) => {
                    this.keys[e.key] = true;
                    
                    if (e.key === ' ' && this.isRunning && !this.isPaused) {
                        e.preventDefault();
                        this.shoot();
                    }
                    
                    if (e.key === 'p' || e.key === 'P') {
                        e.preventDefault();
                        this.togglePause();
                    }
                });
                
                document.addEventListener('keyup', (e) => {
                    this.keys[e.key] = false;
                });
            },

            setupMobileControls() {
                // Left button
                const btnLeft = document.getElementById('btnLeft');
                btnLeft.addEventListener('touchstart', (e) => {
                    e.preventDefault();
                    this.keys['ArrowLeft'] = true;
                });
                btnLeft.addEventListener('touchend', (e) => {
                    e.preventDefault();
                    this.keys['ArrowLeft'] = false;
                });

                // Right button
                const btnRight = document.getElementById('btnRight');
                btnRight.addEventListener('touchstart', (e) => {
                    e.preventDefault();
                    this.keys['ArrowRight'] = true;
                });
                btnRight.addEventListener('touchend', (e) => {
                    e.preventDefault();
                    this.keys['ArrowRight'] = false;
                });

                // Fire button
                const btnFire = document.getElementById('btnFire');
                btnFire.addEventListener('touchstart', (e) => {
                    e.preventDefault();
                    if (this.isRunning && !this.isPaused) {
                        this.shoot();
                    }
                });
                btnFire.addEventListener('click', (e) => {
                    e.preventDefault();
                    if (this.isRunning && !this.isPaused) {
                        this.shoot();
                    }
                });

                // Mobile pause button
                const btnPauseMobile = document.getElementById('btnPauseMobile');
                btnPauseMobile.addEventListener('click', () => {
                    this.togglePause();
                });
            },
            
            start() {
                this.score = 0;
                this.lives = 3;
                this.stage = 1;
                this.isRunning = true;
                this.isPaused = false;
                this.bullets = [];
                this.enemyBullets = [];
                this.particles = [];
                this.player.x = canvas.width / 2 - 20;
                this.player.y = canvas.height - 60;
                
                this.createEnemies();
                this.updateStats();
                this.updateDifficultyDisplay();
                this.gameLoop();
            },
            
            createEnemies() {
                this.enemies = [];
                const rows = Math.min(3 + Math.floor(this.stage / 2), 6);
                const cols = Math.min(6 + Math.floor(this.stage / 3), 10);
                const enemyWidth = 35;
                const enemyHeight = 30;
                const padding = 10;
                const offsetX = (canvas.width - (cols * (enemyWidth + padding))) / 2;
                
                for (let row = 0; row < rows; row++) {
                    for (let col = 0; col < cols; col++) {
                        let enemyType = 'normal';
                        let color = '#0f0';
                        let health = 1;
                        let maxHealth = 1;
                        let points = 10;
                        
                        if (this.stage >= 3 && Math.random() < 0.15) {
                            enemyType = 'special';
                            color = '#ff0';
                            health = 2;
                            maxHealth = 2;
                            points = 30;
                        }
                        
                        if (this.stage >= 5 && row === 0 && col === Math.floor(cols / 2)) {
                            enemyType = 'boss';
                            color = '#f00';
                            health = Math.floor(3 + this.stage / 2);
                            maxHealth = health;
                            points = 100;
                        }
                        
                        this.enemies.push({
                            x: offsetX + col * (enemyWidth + padding),
                            y: 50 + row * (enemyHeight + padding),
                            width: enemyWidth,
                            height: enemyHeight,
                            // Speed increase: 1.2x per stage instead of previous faster increase
                            speed: 1 + (this.stage - 1) * 0.2,
                            direction: 1,
                            color: color,
                            type: enemyType,
                            health: health,
                            maxHealth: maxHealth,
                            points: points
                        });
                    }
                }
                
                // Enemy shot delay: slower increase for smoother difficulty curve
                this.enemyShotDelay = Math.max(500, 1000 - this.stage * 50);
            },
            
            shoot() {
                this.bullets.push({
                    x: this.player.x + this.player.width / 2 - 2,
                    y: this.player.y,
                    width: 4,
                    height: 15,
                    speed: 8,
                    color: '#ff0'
                });
            },
            
            togglePause() {
                if (this.isRunning) {
                    this.isPaused = !this.isPaused;
                    const pauseBtn = document.getElementById('btnPauseMobile');
                    if (pauseBtn) {
                        pauseBtn.textContent = this.isPaused ? 'RESUME' : 'PAUSE';
                    }
                }
            },
            
            updateDifficultyDisplay() {
                document.getElementById('difficulty').textContent = `${this.stage}/10`;
            },
            
            showLevelUpPopup() {
                const popup = document.getElementById('levelupPopup');
                const bonuses = [
                    'üöÄ Enemies get stronger!',
                    '‚ö° Attack speed increased!',
                    'üíé Bonus score opportunity!',
                    'üéØ Special enemies appear!',
                    'üëæ Boss incoming!'
                ];
                
                document.getElementById('levelupStage').textContent = this.stage;
                document.getElementById('levelupBonus').textContent = bonuses[Math.floor(Math.random() * bonuses.length)];
                
                popup.classList.add('show');
                setTimeout(() => {
                    popup.classList.remove('show');
                }, 2000);
            },
            
            update() {
                if (this.isPaused || !this.isRunning) return;
                
                // Player movement
                if (this.keys['ArrowLeft'] && this.player.x > 0) {
                    this.player.x -= this.player.speed;
                }
                if (this.keys['ArrowRight'] && this.player.x < canvas.width - this.player.width) {
                    this.player.x += this.player.speed;
                }
                
                // Stars movement
                this.stars.forEach(star => {
                    star.y += 0.5;
                    if (star.y > canvas.height) {
                        star.y = 0;
                        star.x = Math.random() * canvas.width;
                    }
                });
                
                // Bullets movement
                this.bullets = this.bullets.filter(bullet => {
                    bullet.y -= bullet.speed;
                    return bullet.y > 0;
                });
                
                // Enemy bullets movement
                this.enemyBullets = this.enemyBullets.filter(bullet => {
                    bullet.y += bullet.speed;
                    return bullet.y < canvas.height;
                });
                
                // Particles update
                this.particles = this.particles.filter(p => {
                    p.x += p.vx;
                    p.y += p.vy;
                    p.life--;
                    return p.life > 0;
                });
                
                // Enemy movement
                let moveDown = false;
                this.enemies.forEach(enemy => {
                    enemy.x += enemy.speed * enemy.direction;
                    
                    if (enemy.x <= 0 || enemy.x >= canvas.width - enemy.width) {
                        moveDown = true;
                    }
                });
                
                if (moveDown) {
                    this.enemies.forEach(enemy => {
                        enemy.direction *= -1;
                        enemy.y += 20;
                    });
                }
                
                // Enemy shooting
                const now = Date.now();
                if (now - this.lastEnemyShot > this.enemyShotDelay) {
                    const shooters = this.enemies.filter(e => Math.random() < 0.3);
                    shooters.forEach(enemy => {
                        this.enemyBullets.push({
                            x: enemy.x + enemy.width / 2 - 2,
                            y: enemy.y + enemy.height,
                            width: 4,
                            height: 10,
                            // Enemy bullet speed: slower increase (1.2x per stage)
                            speed: 3 + (this.stage - 1) * 0.15,
                            color: '#f00'
                        });
                    });
                    this.lastEnemyShot = now;
                }
                
                // Collision detection - Player bullets vs Enemies
                this.bullets.forEach((bullet, bIndex) => {
                    this.enemies.forEach((enemy, eIndex) => {
                        if (this.checkCollision(bullet, enemy)) {
                            enemy.health--;
                            this.bullets.splice(bIndex, 1);
                            
                            if (enemy.health <= 0) {
                                this.score += enemy.points;
                                this.createExplosion(enemy.x + enemy.width / 2, enemy.y + enemy.height / 2);
                                this.enemies.splice(eIndex, 1);
                                this.updateStats();
                                
                                if (this.enemies.length === 0) {
                                    this.stageClear();
                                }
                            }
                        }
                    });
                });
                
                // Collision detection - Enemy bullets vs Player
                this.enemyBullets.forEach((bullet, bIndex) => {
                    if (this.checkCollision(bullet, this.player)) {
                        this.enemyBullets.splice(bIndex, 1);
                        this.playerHit();
                    }
                });
                
                // Enemy reaches player
                this.enemies.forEach(enemy => {
                    if (enemy.y + enemy.height >= this.player.y) {
                        this.playerHit();
                    }
                });
            },
            
            checkCollision(rect1, rect2) {
                return rect1.x < rect2.x + rect2.width &&
                       rect1.x + rect1.width > rect2.x &&
                       rect1.y < rect2.y + rect2.height &&
                       rect1.y + rect1.height > rect2.y;
            },
            
            createExplosion(x, y) {
                for (let i = 0; i < 15; i++) {
                    this.particles.push({
                        x: x,
                        y: y,
                        vx: (Math.random() - 0.5) * 6,
                        vy: (Math.random() - 0.5) * 6,
                        life: 30,
                        color: ['#ff0', '#f80', '#f00', '#fff'][Math.floor(Math.random() * 4)]
                    });
                }
            },
            
            playerHit() {
                this.lives--;
                this.updateStats();
                
                this.createExplosion(this.player.x + this.player.width / 2, 
                                   this.player.y + this.player.height / 2);
                
                if (this.lives <= 0) {
                    this.gameOver();
                }
            },
            
            stageClear() {
                if (this.stage >= 10) {
                    this.isRunning = false;
                    
                    saveScore(this.score, this.stage);
                    
                    if (this.score > this.highScore) {
                        this.highScore = this.score;
                        localStorage.setItem('galagaHighScore', this.highScore);
                        document.getElementById('highScore').textContent = this.highScore;
                    }
                    
                    const clearScreen = document.getElementById('stageClearScreen');
                    clearScreen.querySelector('.stage-clear-title').textContent = 'üéâ GAME COMPLETE! üéâ';
                    clearScreen.querySelector('div:nth-child(2)').innerHTML = 
                        `<div style="font-size: 24px; color: #fff; margin-bottom: 20px;">
                            Final Score: ${this.score}<br>
                            <span style="color: #0ff;">You cleared all levels!</span>
                        </div>
                        <button class="btn" onclick="game.restart()">Play Again</button>
                        <button class="btn btn-secondary" onclick="showLeaderboardFromGame()">View Leaderboard</button>`;
                    clearScreen.classList.add('show');
                    return;
                }
                
                this.stage++;
                this.isPaused = true;
                
                this.showLevelUpPopup();
                this.updateDifficultyDisplay();
                
                const clearScreen = document.getElementById('stageClearScreen');
                clearScreen.querySelector('.stage-clear-title').textContent = 'STAGE CLEAR!';
                clearScreen.querySelector('div:nth-child(2)').innerHTML = 
                    '<div style="font-size: 24px; color: #fff; margin-bottom: 20px;">Preparing next stage...</div>';
                clearScreen.classList.add('show');
                
                setTimeout(() => {
                    clearScreen.classList.remove('show');
                    this.createEnemies();
                    this.updateStats();
                    this.isPaused = false;
                }, 2000);
            },
            
            draw() {
                ctx.fillStyle = '#000';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                
                this.stars.forEach(star => {
                    ctx.fillStyle = '#fff';
                    ctx.fillRect(star.x, star.y, star.size, star.size);
                });
                
                this.particles.forEach(p => {
                    ctx.fillStyle = p.color;
                    ctx.globalAlpha = p.life / 30;
                    ctx.fillRect(p.x, p.y, 3, 3);
                    ctx.globalAlpha = 1;
                });
                
                ctx.fillStyle = this.player.color;
                ctx.beginPath();
                ctx.moveTo(this.player.x + this.player.width / 2, this.player.y);
                ctx.lineTo(this.player.x, this.player.y + this.player.height);
                ctx.lineTo(this.player.x + this.player.width, this.player.y + this.player.height);
                ctx.closePath();
                ctx.fill();
                
                ctx.fillStyle = '#00ff00';
                ctx.fillRect(this.player.x - 10, this.player.y + this.player.height - 10, 10, 5);
                ctx.fillRect(this.player.x + this.player.width, this.player.y + this.player.height - 10, 10, 5);
                
                this.bullets.forEach(bullet => {
                    ctx.fillStyle = bullet.color;
                    ctx.fillRect(bullet.x, bullet.y, bullet.width, bullet.height);
                    
                    ctx.shadowBlur = 10;
                    ctx.shadowColor = bullet.color;
                    ctx.fillRect(bullet.x, bullet.y, bullet.width, bullet.height);
                    ctx.shadowBlur = 0;
                });
                
                this.enemies.forEach(enemy => {
                    ctx.fillStyle = enemy.color;
                    
                    if (enemy.type === 'boss') {
                        ctx.fillRect(enemy.x + 5, enemy.y, 25, 10);
                        ctx.fillRect(enemy.x, enemy.y + 10, enemy.width, 15);
                        ctx.fillRect(enemy.x + 10, enemy.y + 25, 15, 10);
                        
                        const healthBarWidth = enemy.width;
                        const healthPercent = enemy.health / enemy.maxHealth;
                        ctx.fillStyle = '#333';
                        ctx.fillRect(enemy.x, enemy.y - 8, healthBarWidth, 4);
                        ctx.fillStyle = healthPercent > 0.5 ? '#0f0' : healthPercent > 0.25 ? '#ff0' : '#f00';
                        ctx.fillRect(enemy.x, enemy.y - 8, healthBarWidth * healthPercent, 4);
                    } else if (enemy.type === 'special') {
                        ctx.save();
                        ctx.translate(enemy.x + enemy.width / 2, enemy.y + enemy.height / 2);
                        ctx.rotate(Date.now() / 500);
                        ctx.beginPath();
                        for (let i = 0; i < 5; i++) {
                            ctx.lineTo(Math.cos((i * 4 * Math.PI) / 5) * 15, 
                                      Math.sin((i * 4 * Math.PI) / 5) * 15);
                        }
                        ctx.closePath();
                        ctx.fill();
                        ctx.restore();
                        
                        if (enemy.health < enemy.maxHealth) {
                            const healthBarWidth = enemy.width;
                            const healthPercent = enemy.health / enemy.maxHealth;
                            ctx.fillStyle = '#333';
                            ctx.fillRect(enemy.x, enemy.y - 8, healthBarWidth, 4);
                            ctx.fillStyle = '#ff0';
                            ctx.fillRect(enemy.x, enemy.y - 8, healthBarWidth * healthPercent, 4);
                        }
                    } else {
                        ctx.fillRect(enemy.x, enemy.y + 10, enemy.width, 15);
                        ctx.fillRect(enemy.x + 10, enemy.y, 15, 10);
                        ctx.fillRect(enemy.x + 5, enemy.y + 25, 5, 5);
                        ctx.fillRect(enemy.x + 25, enemy.y + 25, 5, 5);
                    }
                });
                
                this.enemyBullets.forEach(bullet => {
                    ctx.fillStyle = bullet.color;
                    ctx.fillRect(bullet.x, bullet.y, bullet.width, bullet.height);
                });
                
                if (this.isPaused && this.isRunning) {
                    ctx.fillStyle = 'rgba(255, 255, 0, 0.7)';
                    ctx.font = 'bold 48px Courier New';
                    ctx.textAlign = 'center';
                    ctx.fillText('PAUSED', canvas.width / 2, canvas.height / 2);
                }
            },
            
            gameLoop() {
                this.update();
                this.draw();
                
                if (this.isRunning) {
                    requestAnimationFrame(() => this.gameLoop());
                }
            },
            
            updateStats() {
                document.getElementById('score').textContent = this.score;
                document.getElementById('stage').textContent = this.stage;
                
                let hearts = '';
                for (let i = 0; i < this.lives; i++) {
                    hearts += '‚ù§Ô∏è';
                }
                document.getElementById('lives').textContent = hearts;
            },
            
            gameOver() {
                this.isRunning = false;
                
                saveScore(this.score, this.stage);
                
                if (this.score > this.highScore) {
                    this.highScore = this.score;
                    localStorage.setItem('galagaHighScore', this.highScore);
                    document.getElementById('highScore').textContent = this.highScore;
                }
                
                document.getElementById('finalScore').textContent = this.score;
                document.getElementById('gameOverScreen').classList.add('show');
            },
            
            restart() {
                document.getElementById('gameOverScreen').classList.remove('show');
                document.getElementById('stageClearScreen').classList.remove('show');
                this.start();
            }
        };
        
        game.init();
    </script>
</body>
</html>
